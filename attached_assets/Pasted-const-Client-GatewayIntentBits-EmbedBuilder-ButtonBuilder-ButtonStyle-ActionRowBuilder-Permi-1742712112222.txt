const { Client, GatewayIntentBits, EmbedBuilder, ButtonBuilder, ButtonStyle, ActionRowBuilder, PermissionsBitField } = require('discord.js');
const fs = require('fs');

const client = new Client({ 
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMembers,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,
    GatewayIntentBits.GuildInvites
  ]
});

const prefix = '!';
let giveaways = {};
let users = {};

// Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± ÙØ§ÛŒÙ„
function saveData() {
  fs.writeFileSync('giveaways.json', JSON.stringify(giveaways, null, 2));
  fs.writeFileSync('users.json', JSON.stringify(users, null, 2));
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
try {
  giveaways = JSON.parse(fs.readFileSync('giveaways.json', 'utf8'));
  users = JSON.parse(fs.readFileSync('users.json', 'utf8'));
} catch (err) {
  saveData();
}

client.once('ready', () => {
  console.log(`âœ… Bot ${client.user.tag} is online!`);
});

client.on('messageCreate', async message => {
  if (!message.content.startsWith(prefix) || message.author.bot) return;
  const args = message.content.slice(prefix.length).trim().split(/ +/);
  const command = args.shift().toLowerCase();

  if (command === 'giveaway' && message.member.permissions.has(PermissionsBitField.Flags.Administrator)) {
    const prize = args.join(' ');
    if (!prize) return message.reply('âŒ Ù„Ø·ÙØ§Ù‹ Ø¬Ø§ÛŒØ²Ù‡ Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯.');
    const duration = 3 * 24 * 60 * 60 * 1000;
    const endTime = Date.now() + duration;

    const embed = new EmbedBuilder()
      .setTitle('ğŸ‰ Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ø¬Ø¯ÛŒØ¯!')
      .setDescription(`ğŸ Ø¬Ø§ÛŒØ²Ù‡: **${prize}**\nâ³ Ù¾Ø§ÛŒØ§Ù†: <t:${Math.floor(endTime / 1000)}:R>`)
      .setColor('#FFD700');

    const joinButton = new ButtonBuilder()
      .setCustomId('join_giveaway')
      .setLabel('âœ… Ø´Ø±Ú©Øª Ø¯Ø± Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ')
      .setStyle(ButtonStyle.Success);

    const buyButton = new ButtonBuilder()
      .setCustomId('buy_ticket')
      .setLabel('ğŸ’° Ø®Ø±ÛŒØ¯ Ø¨Ù„ÛŒØ·')
      .setStyle(ButtonStyle.Primary);

    const row = new ActionRowBuilder().addComponents(joinButton, buyButton);
    const giveawayMsg = await message.channel.send({ embeds: [embed], components: [row] });
    
    giveaways[giveawayMsg.id] = { prize, endTime, participants: {} };
    saveData();

    setTimeout(() => endGiveaway(giveawayMsg.id), duration);
  }
});

client.on('interactionCreate', async interaction => {
  if (!interaction.isButton()) return;
  const { customId, user, message } = interaction;

  if (customId === 'join_giveaway') {
    const giveaway = giveaways[message.id];
    if (!giveaway) return interaction.reply({ content: 'âŒ Ø§ÛŒÙ† Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª!', ephemeral: true });
    
    users[user.id] = users[user.id] || { tickets: 0, ccoin: 0, invites: 0 };
    if (users[user.id].tickets === 0) {
      return interaction.reply({ content: 'âŒ Ø´Ù…Ø§ Ø¨Ù„ÛŒØ· Ù†Ø¯Ø§Ø±ÛŒØ¯!', ephemeral: true });
    }

    giveaway.participants[user.id] = users[user.id].tickets;
    saveData();
    interaction.reply({ content: 'âœ… Ø´Ù…Ø§ Ø¯Ø± Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ø´Ø±Ú©Øª Ú©Ø±Ø¯ÛŒØ¯!', ephemeral: true });
  }
});

async function endGiveaway(messageId) {
  const giveaway = giveaways[messageId];
  if (!giveaway) return;

  const entries = [];
  for (const [userId, tickets] of Object.entries(giveaway.participants)) {
    for (let i = 0; i < tickets; i++) {
      entries.push(userId);
    }
  }

  if (entries.length === 0) return;
  const winnerId = entries[Math.floor(Math.random() * entries.length)];
  const message = await client.channels.cache.get(messageId.split('-')[0]).messages.fetch(messageId);
  
  const winEmbed = new EmbedBuilder()
    .setTitle('ğŸ‰ Ø¨Ø±Ù†Ø¯Ù‡ Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ!')
    .setDescription(`ğŸ† Ø¨Ø±Ù†Ø¯Ù‡: <@${winnerId}>\nğŸ Ø¬Ø§ÛŒØ²Ù‡: **${giveaway.prize}**`)
    .setColor('#00FF00');

  message.channel.send({ embeds: [winEmbed] });
  delete giveaways[messageId];
  saveData();
}

client.login(process.env.TOKEN);
